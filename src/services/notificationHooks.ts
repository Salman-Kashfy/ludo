import { whatsappNotificationService } from './whatsappNotificationService';

/**
 * Notification hooks to be called from your models
 * These functions handle the business logic for when to send notifications
 */

export class NotificationHooks {
    /**
     * Hook for customer registration
     * Call this after successfully creating a new customer
     */
    static async onCustomerRegistered(customer: any): Promise<void> {
        try {
            console.log(`Triggering registration notification for customer: ${customer.uuid}`);
            
            await whatsappNotificationService.sendPlayerRegistrationWelcome({
                phoneCode: customer.phoneCode,
                phoneNumber: customer.phoneNumber,
                firstName: customer.firstName,
                lastName: customer.lastName
            });
        } catch (error) {
            console.error('Error in onCustomerRegistered hook:', error);
        }
    }

    /**
     * Hook for table booking
     * Call this after successfully booking a table
     */
    static async onTableBooked(bookingData: {
        customer: any;
        table: any;
        categoryPrice: any;
        session: any;
    }): Promise<void> {
        try {
            console.log(`Triggering table booking notification for customer: ${bookingData.customer.uuid}`);
            
            await whatsappNotificationService.sendTableBookingConfirmation({
                customer: {
                    phoneCode: bookingData.customer.phoneCode,
                    phoneNumber: bookingData.customer.phoneNumber,
                    firstName: bookingData.customer.firstName,
                    lastName: bookingData.customer.lastName
                },
                table: {
                    name: bookingData.table.name,
                    uuid: bookingData.table.uuid
                },
                categoryPrice: {
                    duration: bookingData.categoryPrice.duration,
                    unit: bookingData.categoryPrice.unit,
                    price: bookingData.categoryPrice.price
                },
                sessionId: bookingData.session.uuid
            });
        } catch (error) {
            console.error('Error in onTableBooked hook:', error);
        }
    }

    /**
     * Hook for table session start
     * Call this when a table session is started
     */
    static async onTableSessionStarted(sessionData: {
        customer: any;
        table: any;
        session: any;
    }): Promise<void> {
        try {
            console.log(`Triggering session started notification for customer: ${sessionData.customer.uuid}`);
            
            await whatsappNotificationService.sendTableSessionStarted({
                customer: {
                    phoneCode: sessionData.customer.phoneCode,
                    phoneNumber: sessionData.customer.phoneNumber,
                    firstName: sessionData.customer.firstName,
                    lastName: sessionData.customer.lastName
                },
                table: {
                    name: sessionData.table.name
                },
                duration: sessionData.session.duration,
                unit: sessionData.session.unit,
                freeMins: sessionData.session.freeMins
            });
        } catch (error) {
            console.error('Error in onTableSessionStarted hook:', error);
        }
    }

    /**
     * Hook for tournament registration
     * Call this when a player registers for a tournament
     */
    static async onTournamentRegistration(registrationData: {
        customer: any;
        tournament: any;
    }): Promise<void> {
        try {
            console.log(`Triggering tournament registration notification for customer: ${registrationData.customer.uuid}`);
            
            await whatsappNotificationService.sendTournamentRegistration({
                customer: {
                    phoneCode: registrationData.customer.phoneCode,
                    phoneNumber: registrationData.customer.phoneNumber,
                    firstName: registrationData.customer.firstName,
                    lastName: registrationData.customer.lastName
                },
                tournament: {
                    name: registrationData.tournament.name,
                    date: registrationData.tournament.date,
                    startTime: registrationData.tournament.startTime,
                    entryFee: registrationData.tournament.entryFee,
                    prizePool: registrationData.tournament.prizePool
                }
            });
        } catch (error) {
            console.error('Error in onTournamentRegistration hook:', error);
        }
    }

    /**
     * Hook for tournament start
     * Call this when a tournament is about to start
     */
    static async onTournamentStart(tournamentData: {
        tournament: any;
        participants: any[];
    }): Promise<void> {
        try {
            console.log(`Triggering tournament start notifications for tournament: ${tournamentData.tournament.uuid}`);
            
            const participantData = tournamentData.participants.map(participant => ({
                phoneCode: participant.phoneCode,
                phoneNumber: participant.phoneNumber,
                firstName: participant.firstName,
                lastName: participant.lastName
            }));

            await whatsappNotificationService.sendTournamentStartNotification({
                tournament: {
                    name: tournamentData.tournament.name,
                    date: tournamentData.tournament.date,
                    startTime: tournamentData.tournament.startTime,
                    prizePool: tournamentData.tournament.prizePool
                },
                participants: participantData
            });
        } catch (error) {
            console.error('Error in onTournamentStart hook:', error);
        }
    }

    /**
     * Hook for tournament reminder
     * Call this 30 minutes before tournament start
     */
    static async onTournamentReminder(tournamentData: {
        tournament: any;
        participants: any[];
    }): Promise<void> {
        try {
            console.log(`Triggering tournament reminder notifications for tournament: ${tournamentData.tournament.uuid}`);
            
            const participantData = tournamentData.participants.map(participant => ({
                phoneCode: participant.phoneCode,
                phoneNumber: participant.phoneNumber,
                firstName: participant.firstName,
                lastName: participant.lastName
            }));

            await whatsappNotificationService.sendTournamentReminder({
                tournament: {
                    name: tournamentData.tournament.name,
                    date: tournamentData.tournament.date,
                    startTime: tournamentData.tournament.startTime
                },
                participants: participantData
            });
        } catch (error) {
            console.error('Error in onTournamentReminder hook:', error);
        }
    }

    /**
     * Hook for session expiry warning
     * Call this 5 minutes before session expires
     */
    static async onSessionExpiryWarning(sessionData: {
        customer: any;
        table: any;
        remainingMinutes: number;
    }): Promise<void> {
        try {
            console.log(`Triggering session expiry warning for customer: ${sessionData.customer.uuid}`);
            
            await whatsappNotificationService.sendSessionExpiryWarning({
                customer: {
                    phoneCode: sessionData.customer.phoneCode,
                    phoneNumber: sessionData.customer.phoneNumber,
                    firstName: sessionData.customer.firstName,
                    lastName: sessionData.customer.lastName
                },
                table: {
                    name: sessionData.table.name
                },
                remainingMinutes: sessionData.remainingMinutes
            });
        } catch (error) {
            console.error('Error in onSessionExpiryWarning hook:', error);
        }
    }

    /**
     * Hook for session completion
     * Call this when a session is completed
     */
    static async onSessionCompleted(sessionData: {
        customer: any;
        table: any;
        totalDuration: string;
        totalAmount: number;
    }): Promise<void> {
        try {
            console.log(`Triggering session completed notification for customer: ${sessionData.customer.uuid}`);
            
            await whatsappNotificationService.sendSessionCompleted({
                customer: {
                    phoneCode: sessionData.customer.phoneCode,
                    phoneNumber: sessionData.customer.phoneNumber,
                    firstName: sessionData.customer.firstName,
                    lastName: sessionData.customer.lastName
                },
                table: {
                    name: sessionData.table.name
                },
                totalDuration: sessionData.totalDuration,
                totalAmount: sessionData.totalAmount
            });
        } catch (error) {
            console.error('Error in onSessionCompleted hook:', error);
        }
    }
}